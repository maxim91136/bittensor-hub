name: Smoke Test

on:
  push:
    tags:
      - 'v*'
      - 'v*-rc.*'
  workflow_dispatch:
    inputs:
      url:
        description: 'Network API URL to test (defaults to prod)'
        required: false
        default: 'https://bittensor-labs.com/api/network'

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Health check - Network API
        run: |
          set -e
          URL="${{ github.event.inputs.url || 'https://bittensor-labs.com/api/network' }}"
          echo "Checking $URL"
          # Attempt with default UA; if challenge page is returned, try a browser UA fallback
          STATUS=$(curl -s -o /tmp/body -w "%{http_code}" -A "Mozilla/5.0 (X11; Linux x86_64)" "$URL" ) || true
          echo "HTTP status: $STATUS"
          BODY=$(cat /tmp/body | tr -d '\r')
          if [[ "$STATUS" != "200" ]]; then
            echo "Initial fetch returned $STATUS. Trying with browser UA..."
            STATUS=$(curl -s -o /tmp/body -w "%{http_code}" -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" "$URL") || true
            BODY=$(cat /tmp/body | tr -d '\r')
            echo "Retry status: $STATUS"
          fi
          if [[ "$STATUS" != "200" ]]; then
            echo "ðŸ›‘ Network API returned non-200 code ($STATUS). Body: $(echo "$BODY" | head -c 500)"; exit 1
          fi
          # If the body is Cloudflare challenge page, fail with clear message
          if echo "$BODY" | grep -qi "Just a moment" || echo "$BODY" | grep -qi "Enable JavaScript and cookies"; then
            echo "ðŸ›‘ Cloudflare challenge detected in API response"; exit 1
          fi
          # parse JSON if possible
          echo "$BODY" | jq . > /dev/null || (echo "ðŸ›‘ Invalid JSON"; exit 1)
          # Check required fields
          echo "$BODY" | jq -e '.halvingThresholds | length > 0' || (echo "ðŸ›‘ halvingThresholds missing"; exit 1)
          echo "$BODY" | jq -e '.totalIssuanceHuman != null' || (echo "ðŸ›‘ totalIssuanceHuman missing"; exit 1)

      - name: Health check - Frontend
        run: |
          set -e
          SITE_URL="https://bittensor-labs.com/"
          echo "Checking site root $SITE_URL"
          status=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL") || true
          if [ "$status" != "200" ]; then
            echo "ðŸ›‘ Site root returned non-200"; exit 1
          fi
