name: 'Issuance History Smoke Test'

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *' # Every 30 minutes

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check network API
        run: |
          set -euo pipefail
          # ensure jq is available
          if ! command -v jq >/dev/null 2>&1; then
            echo 'jq not found, installing...'
            sudo apt-get update && sudo apt-get install -y jq
          fi
          TMP_FILE=$(mktemp)
          HTTP_STATUS=$(curl -s -o "$TMP_FILE" -w "%{http_code}" https://bittensor-labs.com/api/issuance_history || true)
          echo "HTTP status for issuance_history: $HTTP_STATUS"
          if [ "$HTTP_STATUS" = "403" ]; then
            echo "ERROR: CF API token does not have Workers KV READ permission (403)."
            echo "Response body:" && cat "$TMP_FILE" || true
            rm -f "$TMP_FILE"
            exit 1
          fi
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Unexpected HTTP status ($HTTP_STATUS) when fetching issuance_history; failing to alert team."
            echo "Response body:" && cat "$TMP_FILE" || true
            rm -f "$TMP_FILE"
            exit 1
          fi
          ISSUANCE_LEN=$(jq 'length' "$TMP_FILE")
          echo "issuance_history length: $ISSUANCE_LEN"
          if [ "$ISSUANCE_LEN" -lt 2 ]; then
            echo 'issuance_history has less than 2 samples; emission_daily will be null. Failing CI to alert team.'
            rm -f "$TMP_FILE"
            exit 1
          fi
          echo "OK: issuance_history has $ISSUANCE_LEN samples"
          rm -f "$TMP_FILE"
